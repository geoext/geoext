<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2015-present The Open Source Geospatial Foundation
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='GeoExt-data-store-Features'>/**
</span> * A data store holding OpenLayers feature objects (`ol.Feature`).
 *
 * @class GeoExt.data.store.Features
 */
Ext.define(&#39;GeoExt.data.store.Features&#39;, {
    extend: &#39;GeoExt.data.store.OlObjects&#39;,
    mixins: [
        &#39;GeoExt.mixin.SymbolCheck&#39;
    ],

<span id='GeoExt-data-store-Features-property-symbols'>    // &lt;debug&gt;
</span>    symbols: [
        &#39;ol.Collection&#39;,
        &#39;ol.layer.Vector&#39;,
        &#39;ol.Map&#39;,
        &#39;ol.Map#addLayer&#39;,
        &#39;ol.Map#removeLayer&#39;,
        &#39;ol.source.Vector&#39;,
        &#39;ol.source.Vector#getFeatures&#39;,
        &#39;ol.source.Vector#on&#39;,
        &#39;ol.source.Vector#un&#39;,
        &#39;ol.style.Circle&#39;,
        &#39;ol.style.Fill&#39;,
        &#39;ol.style.Stroke&#39;,
        &#39;ol.style.Style&#39;
    ],
<span id='GeoExt-data-store-Features-cfg-model'>    // &lt;/debug&gt;
</span>
    model: &#39;GeoExt.data.model.Feature&#39;,

    config: {

<span id='GeoExt-data-store-Features-property-layer'>        /**
</span>         * Initial layer holding features which will be added to the store.
         *
         * The layer object which is in sync with this store.
         *
         * The layer needs to be constructed with an ol.source.Vector that
         * has an ol.Collection (constructor option `features` was set to
         * an ol.Collection).
         *
         * @property {ol.layer.Vector}
         * @readonly
         */
        layer: null
    },

<span id='GeoExt-data-store-Features-cfg-map'>    /**
</span>     * A map object to which a possible #layer will be added.
     *
     * @cfg {ol.Map}
     */
    map: null,

<span id='GeoExt-data-store-Features-cfg-createLayer'>    /**
</span>     * Setting this flag to `true` will create a vector #layer with the
     * given #features and adds it to the given #map (if available).
     *
     * @cfg {Boolean}
     */
    createLayer: false,

<span id='GeoExt-data-store-Features-property-layerCreated'>    /**
</span>     * Shows if the #layer has been created by constructor.
     *
     * @private
     * @property {Boolean}
     */
    layerCreated: false,

<span id='GeoExt-data-store-Features-cfg-style'>    /**
</span>     * An OpenLayers 3 style object to style the vector #layer representing
     * the features of this store.
     *
     * @cfg {ol.Style}
     */
    style: null,

<span id='GeoExt-data-store-Features-cfg-features'>    /**
</span>     * Initial set of features. Has to be an `ol.Collection` object with
     * `ol.Feature` objects in it.
     *
     * @cfg {ol.Collection}
     */
    features: null,

<span id='GeoExt-data-store-Features-cfg-passThroughFilter'>    /**
</span>     * Setting this flag to true the filter of the store will be
     * applied to the underlying vector #layer.
     * This will only have an effect if the source of the #layer is NOT
     * configured with an &#39;url&#39; parameter.
     *
     * @cfg {Boolean}
     */
    passThroughFilter: false,


<span id='GeoExt-data-store-Features-method-constructor'>    /**
</span>     * Constructs the feature store.
     *
     * @param {Object} config The configuration object.
     */
    constructor: function(config) {
        var me = this;

        me.onOlCollectionAdd = me.onOlCollectionAdd.bind(me);
        me.onOlCollectionRemove = me.onOlCollectionRemove.bind(me);

        var cfg = config || {};

        if (me.style === null) {
            me.style = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 6,
                    fill: new ol.style.Fill({
                        color: &#39;#3399CC&#39;
                    }),
                    stroke: new ol.style.Stroke({
                        color: &#39;#fff&#39;,
                        width: 2
                    })
                })
            });
        }

        if (cfg.features !== undefined &amp;&amp; cfg.layer !== undefined) {
            throw new Error(&#39;GeoExt.data.store.Features should only be&#39; +
                &#39; configured with one or less of `features` and `layer`.&#39;);
        }

        var configErrorMessage = &#39;GeoExt.data.store.Features needs to be&#39; +
            &#39; configured with a feature collection or with a layer with a&#39; +
            &#39; source with a feature collection.&#39;;

        if (cfg.features === undefined &amp;&amp; cfg.layer === undefined) {
            cfg.data = new ol.Collection();
        } else if (cfg.features !== undefined) {
            if (!(cfg.features instanceof ol.Collection)) {
                throw new Error(&#39;Features are not a collection. &#39;
                    + configErrorMessage);
            }

            cfg.data = cfg.features;
        } else {
            if (!(cfg.layer instanceof ol.layer.BaseVector)) {
                throw new Error(&#39;Layer is no vector layer. &#39;
                    + configErrorMessage);
            }
            if (!cfg.layer.getSource()) {
                throw new Error(&#39;Layer has no source. &#39; + configErrorMessage);
            }

            var features = cfg.layer.getSource().getFeaturesCollection();
            if (!features) {
                throw new Error(&#39;Source has no collection. &#39;
                    + configErrorMessage);
            }

            cfg.data = features;
        }

        me.callParent([cfg]);

        // create a vector layer and add to map if configured accordingly
        if (me.createLayer === true &amp;&amp; !me.layer) {
            me.drawFeaturesOnMap();
        }

        this.olCollection.on(&#39;add&#39;, this.onOlCollectionAdd);
        this.olCollection.on(&#39;remove&#39;, this.onOlCollectionRemove);

        if (me.passThroughFilter === true) {
            me.on(&#39;filterchange&#39;, me.onFilterChange);
        }
    },

<span id='GeoExt-data-store-Features-method-onOlCollectionAdd'>    /**
</span>     * Forwards changes to the `ol.Collection` to the Ext.data.Store.
     *
     * @param {ol.CollectionEvent} evt The event emitted by the `ol.Collection`.
     * @private
     */
    onOlCollectionAdd: function(evt) {
        var target = evt.target;
        var element = evt.element;
        var idx = Ext.Array.indexOf(target.getArray(), element);

        if (!this.__updating) {
            this.insert(idx, element);
        }
    },

<span id='GeoExt-data-store-Features-method-onOlCollectionRemove'>    /**
</span>     * Forwards changes to the `ol.Collection` to the Ext.data.Store.
     *
     * @param {ol.CollectionEvent} evt The event emitted by the `ol.Collection`.
     * @private
     */
    onOlCollectionRemove: function(evt) {
        var element = evt.element;
        var idx = this.findBy(function(rec) {
            return rec.olObject === element;
        });

        if (idx !== -1) {
            if (!this.__updating) {
                this.removeAt(idx);
            }
        }
    },

<span id='GeoExt-data-store-Features-method-applyFields'>    applyFields: function(fields) {
</span>        var me = this;
        if (fields) {
            this.setModel(
                Ext.data.schema.Schema.lookupEntity(me.config.model)
            );
        }
    },

<span id='GeoExt-data-store-Features-method-getFeatures'>    /**
</span>     * Returns the FeatureCollection which is in sync with this store.
     *
     * @return {ol.Collection} The underlying OpenLayers `ol.Collection` of
     *     `ol.Feature`.
     */
    getFeatures: function() {
        return this.olCollection;
    },

<span id='GeoExt-data-store-Features-method-getByFeature'>    /**
</span>     * Returns the record corresponding to a feature.
     *
     * @param {ol.Feature} feature An ol.Feature object to get the record for
     * @return {Ext.data.Model} The model instance corresponding to the feature
     */
    getByFeature: function(feature) {
        return this.getAt(this.findBy(function(record) {
            return record.getFeature() === feature;
        }));
    },

<span id='GeoExt-data-store-Features-method-destroy'>    /**
</span>     * Overwrites the destroy function to ensure the #layer is removed from
     * the #map when it has been created automatically while construction in
     * case of destruction of this store.
     *
     * @protected
     */
    destroy: function() {
        this.olCollection.un(&#39;add&#39;, this.onCollectionAdd);
        this.olCollection.un(&#39;remove&#39;, this.onCollectionRemove);

        var me = this;

        if (me.map &amp;&amp; me.layerCreated === true) {
            me.map.removeLayer(me.layer);
        }

        me.callParent(arguments);
    },

<span id='GeoExt-data-store-Features-method-drawFeaturesOnMap'>    /**
</span>     * Draws the given #features on the #map.
     *
     * @private
     */
    drawFeaturesOnMap: function() {
        var me = this;

        // create a layer representation of our features
        me.source = new ol.source.Vector({
            features: me.getFeatures()
        });
        me.layer = new ol.layer.Vector({
            source: me.source,
            style: me.style
        });
        // add layer to connected map, if available
        if (me.map) {
            me.map.addLayer(me.layer);
        }

        me.layerCreated = true;
    },

<span id='GeoExt-data-store-Features-method-onFilterChange'>    /**
</span>     * Handles the &#39;filterchange&#39;-event.
     * Applies the filter of this store to the underlying layer.
     * @private
     */
    onFilterChange: function() {
        var me = this;
        if (me.layer &amp;&amp; me.layer.getSource() instanceof ol.source.Vector) {
            if (!me.__updating) {

                me.__updating = true;

                me.olCollection.clear();

                // add the filtered features to the collection
                me.each(function(rec) {
                    me.olCollection.push(rec.getFeature());
                });

                delete me.__updating;
            }
        }
    }

});
</pre>
</body>
</html>
