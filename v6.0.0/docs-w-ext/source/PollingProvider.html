<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Ext-direct-PollingProvider'>/**
</span> * Provides for repetitive polling of the server at distinct {@link #interval intervals}.
 * The initial request for data originates from the client, and then is responded to by the
 * server.
 * 
 * Configuration for the PollingProvider can be generated by the server-side
 * API portion of the Ext Direct stack.
 *
 * An instance of PollingProvider may be created directly via the new keyword or by simply
 * specifying `type = &#39;polling&#39;`. For example:
 *
 *      var pollA = new Ext.direct.PollingProvider({
 *          type:&#39;polling&#39;,
 *          url: &#39;php/pollA.php&#39;,
 *      });
 *      Ext.direct.Manager.addProvider(pollA);
 *      pollA.disconnect();
 *      
 *      Ext.direct.Manager.addProvider({
 *          type:&#39;polling&#39;,
 *          url: &#39;php/pollB.php&#39;,
 *          id: &#39;pollB-provider&#39;
 *      });
 *      var pollB = Ext.direct.Manager.getProvider(&#39;pollB-provider&#39;);
 *
 */
Ext.define(&#39;Ext.direct.PollingProvider&#39;, {
    extend: &#39;Ext.direct.JsonProvider&#39;,
    alias:  &#39;direct.pollingprovider&#39;,
    
    requires: [
        &#39;Ext.Ajax&#39;,
        &#39;Ext.util.TaskRunner&#39;,
        &#39;Ext.direct.ExceptionEvent&#39;
    ],
    
<span id='Ext-direct-PollingProvider-property-type'>    type: &#39;polling&#39;,
</span>    
<span id='Ext-direct-PollingProvider-cfg-interval'>    /**
</span>     * @cfg {Number} [interval=3000]
     * How often to poll the server-side in milliseconds. Defaults to every 3 seconds.
     */
    interval: 3000,

<span id='Ext-direct-PollingProvider-cfg-baseParams'>    /**
</span>     * @cfg {Object} [baseParams]
     * An object containing properties which are to be sent as parameters on every
     * polling request. Note that if baseParams are set and {@link #url} parameter
     * is an URL string, poll requests will use POST method instead of default GET.
     */
    
<span id='Ext-direct-PollingProvider-cfg-url'>    /**
</span>     * @cfg {String/Function} url
     * The url which the PollingProvider should contact with each request. This can also be
     * an imported Ext Direct method which will be passed baseParams as named arguments.
     *
     * *Note* that using Function `url` is deprecated, use {@link #pollFn} instead.
     * @deprecated 5.1.0
     */
    
<span id='Ext-direct-PollingProvider-cfg-pollFn'>    /**
</span>     * @cfg {String/Function} pollFn
     *
     * Ext Direct method to use for polling. If a method name is provided as a string,
     * the actual function will not be resolved until the first time this provider
     * is connected.
     *
     * The method should accept named arguments and will be passed {@link #baseParams}
     * if set.
     */
    
<span id='Ext-direct-PollingProvider-cfg-timeout'>    /**
</span>     * @cfg {Number} [timeout]
     *
     * The timeout to use for each request.
     */
    
<span id='Ext-direct-PollingProvider-event-beforepoll'>    /**
</span>     * @event beforepoll
     * @preventable
     * Fired immediately before a poll takes place.
     *
     * @param {Ext.direct.PollingProvider} this
     */

<span id='Ext-direct-PollingProvider-event-poll'>    /**
</span>     * @event poll
     * Fired immediately after a poll takes place.
     *
     * @param {Ext.direct.PollingProvider} this
     */
    
    constructor: function(config) {
        var me = this;
        
        me.callParent([config]);
        
        me.pollTask = Ext.TaskManager.newTask({
            run: me.runPoll,
            interval: me.interval,
            scope: me
        });
    },
    
<span id='Ext-direct-PollingProvider-method-destroy'>    destroy: function() {
</span>        this.pollTask = null;
        
        this.callParent();
    },
    
<span id='Ext-direct-PollingProvider-method-doConnect'>    doConnect: function() {
</span>        var me = this,
            url = me.url,
            pollFn = me.pollFn;
        
        // It is important that pollFn resolution happens at the time when
        // Provider is first connected, and not at construction time. If
        // pollFn is configured as a string, the API stub may not exist yet
        // when PollingProvider is constructed.
        if (pollFn &amp;&amp; Ext.isString(pollFn)) {
            //&lt;debug&gt;
            var fnName = pollFn;
            //&lt;/debug&gt;
            
            me.pollFn = pollFn = Ext.direct.Manager.parseMethod(pollFn);
            
            //&lt;debug&gt;
            if (!Ext.isFunction(pollFn)) {
                Ext.raise(&quot;Cannot resolve Ext Direct API method &quot; + fnName +
                                &quot; for PollingProvider&quot;);
            }
            //&lt;/debug&gt;
        }
        else if (Ext.isFunction(url)) {
            //&lt;debug&gt;
            Ext.log.warn(&#39;Using a function for url is deprecated, use pollFn instead.&#39;);
            //&lt;/debug&gt;
            
            me.pollFn = pollFn = url;
            me.url = url = null;
        }
        
        if (url || pollFn) {
            me.setInterval(me.interval);
            
            me.pollTask.start();
        }
    },

<span id='Ext-direct-PollingProvider-method-doDisconnect'>    doDisconnect: function() {
</span>        if (this.pollTask) {
            this.pollTask.stop();
        }
    },
    
<span id='Ext-direct-PollingProvider-method-getInterval'>    getInterval: function() {
</span>        return this.pollTask &amp;&amp; this.pollTask.interval;
    },
    
<span id='Ext-direct-PollingProvider-method-setInterval'>    setInterval: function(interval) {
</span>        var me = this,
            pollTask = me.pollTask;
        
        //&lt;debug&gt;
        if (interval &lt; 100) {
            Ext.raise(&quot;Attempting to configure PollProvider &quot; + me.id +
                            &quot; with interval that is less than 100ms.&quot;);
                            
        }
        //&lt;/debug&gt;
        
        me.interval = pollTask.interval = interval;
        
        if (me.isConnected()) {
            pollTask.restart(interval);
        }
    },
    
<span id='Ext-direct-PollingProvider-method-runPoll'>    /**
</span>     * @private
     */
    runPoll: function() {
        var me = this,
            url = me.url,
            pollFn = me.pollFn,
            baseParams = me.baseParams,
            args, request;
        
        if (me.fireEvent(&#39;beforepoll&#39;, me) !== false) {
            if (pollFn) {
                args = pollFn.directCfg.method.getArgs({
                    params: baseParams !== undefined ? baseParams : {},
                    callback: me.onPollFn,
                    scope: me
                });
                
                pollFn.apply(window, args);
            }
            else {
                request = {
                    url: url,
                    callback: me.onData,
                    scope: me,
                    params: baseParams,
                    headers: me.getHeaders()
                };
                
                if (me.timeout != null) {
                    request.timeout = me.timeout;
                }
                
                me.sendAjaxRequest(request);
            }
            
            me.fireEvent(&#39;poll&#39;, me);
        }
    },

<span id='Ext-direct-PollingProvider-method-onData'>    /**
</span>     * @private
     */
    onData: function(opt, success, response) {
        var me = this, 
            i, len, events, event;
        
        if (success) {
            events = me.createEvents(response);
            
            for (i = 0, len = events.length; i &lt; len; ++i) {
                event = events[i];
                
                me.fireEvent(&#39;data&#39;, me, event);
                
                if (!event.status) {
                    me.fireEvent(&#39;exception&#39;, me, event);
                }
            }
        }
        else {
            event = new Ext.direct.ExceptionEvent({
                data: null,
                code: Ext.direct.Manager.exceptions.TRANSPORT,
                message: &#39;Unable to connect to the server.&#39;,
                xhr: response
            });
            
            me.fireEvent(&#39;data&#39;, me, event);
            me.fireEvent(&#39;exception&#39;, me, event);
        }
        
        me.callParent([opt, success, response]);
    },
    
<span id='Ext-direct-PollingProvider-method-onPollFn'>    /**
</span>     * @private
     */
    onPollFn: function(result, event, success, options) {
        this.onData(null, success, { responseText: result });
    },
    
    inheritableStatics: {
<span id='Ext-direct-PollingProvider-static-method-checkConfig'>        /**
</span>         * @private
         * @static
         * @inheritable
         */
        checkConfig: function(config) {
            // Polling provider needs either URI or pollFn
            return config &amp;&amp; config.type === &#39;polling&#39; &amp;&amp;
                   (config.url || config.pollFn);
        }
    }
});
</pre>
</body>
</html>
